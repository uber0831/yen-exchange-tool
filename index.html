<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <title>æ›æ—¥åœ“æ¯”è¼ƒå·¥å…·</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 2rem;
            max-width: 600px;
            margin: auto;
        }

        label {
            display: block;
            margin-top: 1rem;
        }

        input {
            width: 100%;
            padding: 0.5rem;
            font-size: 1rem;
        }

        button {
            margin-top: 1.2rem;
            padding: 0.75rem;
            width: 100%;
            font-size: 1.1rem;
            cursor: pointer;
        }

        .result,
        .history {
            margin-top: 2rem;
            font-size: 1rem;
            background: #f9f9f9;
            padding: 1rem;
            border-radius: 0.5rem;
        }

        .history {
            font-size: 0.95rem;
        }
    </style>
</head>

<body>
    <h2>æ›æ—¥åœ“æ¯”è¼ƒå·¥å…·ï¼ˆå›ºå®šç›®æ¨™é‡‘é¡ï¼‰</h2>

    <label>ä½ æƒ³è¦å…Œæ›çš„æ—¥åœ“é‡‘é¡ï¼ˆJPYï¼‰
        <input type="number" id="targetJPY" value="100000">
    </label>
    <label>1 ç¾å…ƒ = å¹¾æ—¥åœ“ï¼ˆUSD/JPYï¼‰
        <input type="number" id="usdjpy" value="146">
    </label>
    <label>ç›®å‰ 1 ç¾å…ƒ = å¹¾å°å¹£ï¼ˆTWD/USDï¼Œç¾å€¼ï¼‰
        <input type="number" id="currentTwdusd" value="33">
    </label>
    <label>ä½ å…ˆå‰æŒæœ‰ç¾é‡‘çš„æ›åŒ¯æˆæœ¬ï¼ˆTWD/USD åŒ¯ç‡ï¼‰
        <input type="number" id="pastTwdusd" value="32.9691">
    </label>
    <label>å‚™è¨»ï¼ˆå¯é¸å¡«ï¼‰
        <input type="text" id="note" placeholder="ä¾‹å¦‚ï¼šæ—…è¡Œç”¨ã€è–ªæ°´æ›åŒ¯ç­‰">
    </label>

    <button onclick="calculateJPYTargetComparison()">ç«‹å³æ¯”è¼ƒ</button>
    <button onclick="downloadHistory()">ğŸ“ ä¸‹è¼‰åŒ¯ç‡è¨˜éŒ„ (.txt)</button>
    <button onclick="downloadCSV()">ğŸ“Š åŒ¯å‡º CSV</button>
    <button onclick="clearHistory()">ğŸ—‘ï¸ æ¸…é™¤æ­·å²è¨˜éŒ„</button>

    <div class="result" id="result"></div>
    <div class="history" id="history"></div>

    <script>
        let historyLog = JSON.parse(localStorage.getItem("fxHistory") || "[]");

        function updateHistoryDisplay() {
            document.getElementById('history').innerHTML = "<strong>ğŸ“… åŒ¯ç‡è¨˜éŒ„</strong><br>" +
                (historyLog.length ? historyLog.map(item => item.text).join("<br>") : "å°šç„¡è¨˜éŒ„");
        }

        function calculateJPYTargetComparison() {
            const targetJPY = parseFloat(document.getElementById('targetJPY').value);
            const usdjpy = parseFloat(document.getElementById('usdjpy').value);
            const currentTwdusd = parseFloat(document.getElementById('currentTwdusd').value);
            const pastTwdusd = parseFloat(document.getElementById('pastTwdusd').value);
            const note = document.getElementById('note').value;

            if (
                isNaN(targetJPY) ||
                isNaN(usdjpy) ||
                isNaN(currentTwdusd) ||
                isNaN(pastTwdusd)
            ) {
                alert("è«‹ç¢ºèªæ‰€æœ‰æ¬„ä½éƒ½æœ‰æ­£ç¢ºå¡«å¯«ï¼");
                return;
            }

            const requiredUSD = targetJPY / usdjpy;
            const costTWD_now = requiredUSD * currentTwdusd;
            const costTWD_past = requiredUSD * pastTwdusd;

            let message = `ğŸ¯ ç›®æ¨™æ—¥åœ“é‡‘é¡ï¼š${targetJPY.toFixed(0)} JPY<br><br>`;
            message += `ğŸ’µã€ä½¿ç”¨ç¾æœ‰ç¾å…ƒï¼ˆéå»åŒ¯ç‡ ${pastTwdusd}ï¼‰ã€‘<br>`;
            message += `éœ€è¦ç´„ ${requiredUSD.toFixed(2)} USD<br>`;
            message += `ç•¶åˆæˆæœ¬ï¼šç´„ <strong>${costTWD_past.toFixed(2)} TWD</strong><br><br>`;
            message += `ğŸ’±ã€ç¾åœ¨ç”¨å°å¹£æ›ç¾å…ƒå†æ›æ—¥åœ“ï¼ˆåŒ¯ç‡ ${currentTwdusd}ï¼‰ã€‘<br>`;
            message += `éœ€è¦ç´„ ${requiredUSD.toFixed(2)} USD<br>`;
            message += `ç¾å€¼æˆæœ¬ï¼šç´„ <strong>${costTWD_now.toFixed(2)} TWD</strong><br><br>`;

            if (costTWD_past < costTWD_now) {
                message += "âœ… <strong>ä½¿ç”¨ç¾æœ‰ç¾å…ƒï¼ˆèˆŠåŒ¯ç‡ï¼‰æ›æ—¥åœ“æ¯”è¼ƒåˆ’ç®—ï¼</strong>";
            } else if (costTWD_past > costTWD_now) {
                message += "âœ… <strong>ç”¨ç¾åœ¨å°å¹£æ›ç¾å…ƒå†æ›æ—¥åœ“æ¯”è¼ƒåˆ’ç®—ï¼</strong>";
            } else {
                message += "âš–ï¸ <strong>å…©ç¨®æ–¹å¼ä¸€æ¨£åˆ’ç®—ï¼</strong>";
            }

            document.getElementById('result').innerHTML = message;

            const today = new Date().toISOString().split('T')[0];
            const textEntry = `${today}ï½œUSD/JPY: ${usdjpy}, TWD/USD(ç¾): ${currentTwdusd}, TWD/USD(èˆŠ): ${pastTwdusd}${note ? `ï½œå‚™è¨»ï¼š${note}` : ""}`;
            const csvEntry = `${today},${usdjpy},${currentTwdusd},${pastTwdusd},${note.replace(/,/g, 'ï¼Œ')}`;
            historyLog.unshift({ text: textEntry, csv: csvEntry });
            localStorage.setItem("fxHistory", JSON.stringify(historyLog));
            updateHistoryDisplay();

            // ğŸ” è‡ªå‹•åŒæ­¥åˆ° Google Sheets
            fetch("https://script.google.com/macros/s/AKfycbzaoiaPXUGkzwTzJQX6xFU7MdG8M8saH1PpXyVlPAmucE5TRZc1uaSI6UHyTLpPhkzMqg/exec", {
                method: "POST",
                body: JSON.stringify({ usdjpy, currentTwdusd, pastTwdusd, note }),
                headers: { "Content-Type": "application/json" }
            })
                .then(res => {
                    if (res.ok) {
                        console.log("âœ… æˆåŠŸåŒæ­¥è‡³ Google Sheets");
                    } else {
                        alert("âš ï¸ åŒæ­¥ Google Sheets å¤±æ•—ï¼Œç‹€æ…‹ç¢¼ï¼š" + res.status);
                    }
                })
                .catch(err => {
                    alert("âŒ ç™¼é€è‡³ Google Sheets å¤±æ•—ï¼š" + err.message);
                });
        }

        function downloadHistory() {
            if (historyLog.length === 0) return alert("ç›®å‰æ²’æœ‰åŒ¯ç‡è¨˜éŒ„å¯ä¸‹è¼‰ï¼");
            const blob = new Blob([historyLog.map(e => e.text).join("\\n")], { type: "text/plain" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "åŒ¯ç‡è¨˜éŒ„.txt";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function downloadCSV() {
            if (historyLog.length === 0) return alert("ç›®å‰æ²’æœ‰è¨˜éŒ„ï¼");
            const csv = ["æ—¥æœŸ,USD/JPY,TWD/USD(ç¾),TWD/USD(èˆŠ),å‚™è¨»", ...historyLog.map(e => e.csv)].join("\\n");
            const blob = new Blob([csv], { type: "text/csv" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "åŒ¯ç‡è¨˜éŒ„.csv";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function clearHistory() {
            if (!confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰åŒ¯ç‡è¨˜éŒ„å—ï¼Ÿ")) return;
            historyLog = [];
            localStorage.removeItem("fxHistory");
            updateHistoryDisplay();
        }

        updateHistoryDisplay();
    </script>
</body>

</html>